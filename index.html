<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gmail API Test Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <main class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
        <h1 class="text-3xl font-bold mb-4 text-gray-800">Gmail API Test Page</h1>
        <p class="text-gray-600 mb-6">
            Sign in with your Google account to authorize the application.
        </p>

        <!-- The main button to trigger the sign-in process -->
        <button id="google-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
            Sign in with Google
        </button>

        <!-- This section is hidden by default and will be shown if the popup is blocked -->
        <div id="fallback-message" class="mt-4 text-gray-500 hidden">
            <p>
                Looks like your browser blocked the sign-in popup. Please click the button below to continue the login process.
            </p>
            <a id="fallback-link" class="mt-2 inline-block text-blue-600 hover:text-blue-800 transition-colors duration-200">
                Continue to Login Page
            </a>
        </div>
    </main>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Supabase credentials
        const SUPABASE_URL = 'https://mzerlmfatyyummpjikxs.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16ZXJsbWZhdHl5dW1tcGppa3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTY5MzMsImV4cCI6MjA3MzkzMjkzM30.DPa4fMqeSqis7OQE2bIhKz3vQiJ1fXfZXXD8MggccIg';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            console.log("Auth event:", event);
            console.log("Session:", session);
            if (session) {
                console.log("User is logged in:", session.user.email);
            }
        });

        // Sign-in function with popup fallback
        const signInWithGoogle = async () => {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://konira-ai.github.io/gmail-api-test-page/',
                    queryParams: { access_type: 'offline', prompt: 'consent' },
                    scopes: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/gmail.send'
                }
            });

            if (!data?.url && error) {
                console.error("Popup blocked or login failed:", error);

                // Show fallback link
                document.getElementById('fallback-message').classList.remove('hidden');
                const fallbackLink = document.getElementById('fallback-link');
                fallbackLink.href = 'https://konira-ai.github.io/gmail-api-test-page/';
                fallbackLink.onclick = () => {
                    window.open('https://konira-ai.github.io/gmail-api-test-page/', '_self');
                };
            }
        };

        // Attach listener
        document.getElementById('google-signin-btn').addEventListener('click', signInWithGoogle);
    </script>
</body>
</html>
