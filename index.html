<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gmail API Test Page</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
  <main class="bg-white p-8 rounded-lg shadow-lg max-w-sm w-full text-center">
    <h1 class="text-3xl font-bold mb-4 text-gray-800">Gmail API Test Page</h1>
    <p class="text-gray-600 mb-6">Sign in with your Google account to authorize the application.</p>
    <button id="google-signin-btn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 transition">
      Sign in with Google
    </button>
    <div id="user-info" class="mt-4 hidden"></div>
    <button id="send-email-btn" class="w-full mt-4 bg-green-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-green-700 transition hidden">
      Send Test Email
    </button>
  </main>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = 'https://mzerlmfatyyummpjikxs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im16ZXJsbWZhdHl5dW1tcGppa3hzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzNTY5MzMsImV4cCI6MjA3MzkzMjkzM30.DPa4fMqeSqis7OQE2bIhKz3vQiJ1fXfZXXD8MggccIg';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const signInBtn = document.getElementById('google-signin-btn');
    const sendEmailBtn = document.getElementById('send-email-btn');
    const userInfo = document.getElementById('user-info');

    function showUser(email) {
      userInfo.textContent = `✅ Logged in as ${email}`;
      userInfo.classList.remove('hidden');
      sendEmailBtn.classList.remove('hidden');
      signInBtn.classList.add('hidden');
    }

    function resetUI() {
      userInfo.textContent = '';
      userInfo.classList.add('hidden');
      sendEmailBtn.classList.add('hidden');
      signInBtn.classList.remove('hidden');
    }

    function setUpSendEmail(email, accessToken) {
      sendEmailBtn.onclick = async () => {
        const rawMessage =
          `From: ${email}\r\n` +
          `To: ${email}\r\n` +
          `Subject: Test Email from Konira App\r\n` +
          `\r\nThis is a test email sent via Gmail API + Supabase OAuth.`;

        const base64EncodedEmail = btoa(unescape(encodeURIComponent(rawMessage)))
          .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

        try {
          const response = await fetch('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ raw: base64EncodedEmail })
          });
          const respJson = await response.json();
          if (response.ok) {
            alert('✅ Test email sent successfully!');
          } else {
            alert('❌ Failed to send email: ' + (respJson?.error?.message || 'unknown'));
          }
        } catch (err) {
          alert('❌ Unexpected error: ' + err.message);
        }
      };
    }

    async function handleSession(session) {
      console.log('Session object:', session); // Debug log
      if (!session?.user) {
        resetUI();
        return;
      }
      const email = session.user.email;
      const accessToken = session.provider_token || session?.provider_access_token || session?.access_token;
      showUser(email);
      setUpSendEmail(email, accessToken);
    }

    async function initialize() {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) console.error('Session error:', error);
      await handleSession(session);
    }

    supabase.auth.onAuthStateChange(async (_event, session) => {
      await handleSession(session);
    });

    // Force hardcoded redirectTo for GitHub Pages
    signInBtn.addEventListener('click', async () => {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: 'https://konira-ai.github.io/gmail-api-test-page/',
          queryParams: { access_type: 'offline', prompt: 'consent' },
          scopes: 'https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/gmail.send'
        }
      });
      if (error) console.error('Error signing in:', error);
    });

    initialize();
  </script>
</body>
</html>
